<!DOCTYPE html>
<html lang="ko">
<!--
=================================================================================
ëŒ€í”¼ì†Œ ì•ˆë‚´ ì±—ë´‡ - í”„ë¡ íŠ¸ì—”ë“œ (shelter_1.0.html)
=================================================================================

[í”„ë¡œì íŠ¸ ê°œìš”]
- ì‚¬ìš©ì ìœ„ì¹˜ ê¸°ë°˜ ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ ê²€ìƒ‰ ë° ì¬ë‚œí–‰ë™ìš”ë ¹ ì•ˆë‚´
- FastAPI ë°±ì—”ë“œ(app_new.py)ì™€ ì—°ë™í•˜ì—¬ LLM ê¸°ë°˜ ì˜ë„ ë¶„ë¥˜ ë° ê²€ìƒ‰
- ë„¤ì´ë²„ ì§€ë„ APIë¥¼ í†µí•œ ì‹œê°ì  ëŒ€í”¼ì†Œ ìœ„ì¹˜ í‘œì‹œ

[ì‚¬ìš© ê¸°ìˆ  ìŠ¤íƒ]
- Tailwind CSS: ë°˜ì‘í˜• UI ìŠ¤íƒ€ì¼ë§
- Naver Maps API: ì§€ë„ í‘œì‹œ ë° ë§ˆì»¤ ìƒì„±
- Fetch API: FastAPI ì„œë²„ì™€ ë¹„ë™ê¸° í†µì‹ 
- Geolocation API: ì‚¬ìš©ì GPS ìœ„ì¹˜ íšë“
- JavaScript (ES6+): í´ë¼ì´ì–¸íŠ¸ ë¡œì§ êµ¬í˜„

[ë°±ì—”ë“œ API ì—°ë™]
- ì„œë²„: FastAPI (app_new.py)
- ì—”ë“œí¬ì¸íŠ¸:
  * GET  /api/status                 - ì„œë²„ ìƒíƒœ ë° LLM ê°€ìš©ì„± í™•ì¸
  * POST /api/location/extract       - ì˜ë„ ë¶„ë¥˜ ë° ëŒ€í”¼ì†Œ/ì¬ë‚œí–‰ë™ìš”ë ¹ ê²€ìƒ‰
  * GET  /api/shelters/nearest       - GPS ì¢Œí‘œ ê¸°ë°˜ ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ ê²€ìƒ‰

=================================================================================
[í•¨ìˆ˜ ëª©ë¡ ë° ì—­í• ]
=================================================================================

[1] ì´ˆê¸°í™” ë° ì„¤ì •
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  - ì—­í• : í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ API ì„œë²„ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸° UI ì„¤ì •
  - í˜¸ì¶œ í•¨ìˆ˜: checkApiStatus() â†’ updateLlmBadge() â†’ showActionButtons()
  - ë°±ì—”ë“œ ì—°ë™: GET /api/status

âœ“ API_BASE_URL (ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜)
  - ì—­í• : í˜„ì¬ ì ‘ì† í™˜ê²½(í”„ë¡œí† ì½œ, í˜¸ìŠ¤íŠ¸ëª…, í¬íŠ¸)ì„ ê°ì§€í•˜ì—¬ API ì„œë²„ ì£¼ì†Œ ìë™ ì„¤ì •
  - ë°˜í™˜: 'https://127.0.0.1:8443' ë˜ëŠ” ë™ì  URL

[2] ì„œë²„ API ì—°ë™ í•¨ìˆ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ checkApiStatus()
  - ì—­í• : FastAPI ì„œë²„ ì—°ê²° ìƒíƒœ ë° LLM ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
  - ë°±ì—”ë“œ ì—°ë™: GET /api/status
  - í˜¸ì¶œ í•¨ìˆ˜: updateLlmBadge()
  - ì „ì—­ ë³€ìˆ˜ ì„¤ì •: API_AVAILABLE, USE_LLM

âœ“ updateLlmBadge()
  - ì—­í• : ìš°ì¸¡ ìƒë‹¨ LLM ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸ (LLM ON / ê·œì¹™ ê¸°ë°˜ / ë¡œì»¬ ëª¨ë“œ)
  - DOM ì¡°ì‘: #llm-status ìš”ì†Œì˜ í´ë˜ìŠ¤ ë° í…ìŠ¤íŠ¸ ë³€ê²½

âœ“ extractLocationWithLLM(query)
  - ì—­í• : ì‚¬ìš©ì ì…ë ¥ì„ FastAPI ì„œë²„ë¡œ ì „ì†¡í•˜ì—¬ ì˜ë„ ë¶„ë¥˜ ë° ê²€ìƒ‰ ìˆ˜í–‰
  - íŒŒë¼ë¯¸í„°: query (ì‚¬ìš©ì ì…ë ¥ ë¬¸ìì—´)
  - ë°±ì—”ë“œ ì—°ë™: POST /api/location/extract
  - ë°˜í™˜: { success, location, coordinates, shelters, message } ë˜ëŠ” null

âœ“ searchSheltersByCoordinates(lat, lon, locationName)
  - ì—­í• : ìœ„ê²½ë„ ì¢Œí‘œ ê¸°ë°˜ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ 5ê³³ ê²€ìƒ‰
  - íŒŒë¼ë¯¸í„°: lat(ìœ„ë„), lon(ê²½ë„), locationName(ìœ„ì¹˜ëª…, ì˜µì…˜)
  - ë°±ì—”ë“œ ì—°ë™: GET /api/shelters/nearest?lat={lat}&lon={lon}&k=5
  - ë°˜í™˜: ëŒ€í”¼ì†Œ ë°°ì—´ [{ name, address, lat, lon, capacity, distance }] ë˜ëŠ” null

[3] UI ì œì–´ í•¨ìˆ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ setControlsDisabled(disabled)
  - ì—­í• : ëª¨ë“  ë²„íŠ¼ ë° ì…ë ¥ì°½ í™œì„±í™”/ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
  - íŒŒë¼ë¯¸í„°: disabled (boolean)
  - ëŒ€ìƒ ìš”ì†Œ: #geo-btn, #send-btn, #chat-input

âœ“ showActionButtons(enableControls)
  - ì—­í• : í˜„ìœ„ì¹˜ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ë° í™œì„±í™” ì œì–´
  - íŒŒë¼ë¯¸í„°: enableControls (boolean)
  - í˜¸ì¶œ í•¨ìˆ˜: setControlsDisabled(!enableControls)
  - DOM ì¡°ì‘: #initial-actionsì˜ hidden í´ë˜ìŠ¤ í† ê¸€

âœ“ addMessage(sender, text, isResult)
  - ì—­í• : ì±„íŒ…ì°½ì— ë©”ì‹œì§€ ì¶”ê°€ (ì‚¬ìš©ì/ë´‡/ê²°ê³¼ ë©”ì‹œì§€ êµ¬ë¶„)
  - íŒŒë¼ë¯¸í„°: sender ('user' | 'bot'), text (HTML ë¬¸ìì—´), isResult (boolean)
  - DOM ì¡°ì‘: #chat-windowì— ë©”ì‹œì§€ div ì¶”ê°€ ë° ìŠ¤í¬ë¡¤ ì´ë™

[4] GPS ë° ìœ„ì¹˜ ì²˜ë¦¬ í•¨ìˆ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ handleGeolocation()
  - ì—­í• : "í˜„ìœ„ì¹˜ë¡œ ì°¾ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ GPS ìœ„ì¹˜ ìš”ì²­ ì‹œì‘
  - í˜¸ì¶œ í•¨ìˆ˜: 
    - setControlsDisabled(true)
    - addMessage('user', ...), addMessage('bot', ...)
    - navigator.geolocation.getCurrentPosition(onSuccessGeolocation, onErrorGeolocation)
  - ì‚¬ìš©ì íŠ¸ë¦¬ê±°: ë²„íŠ¼ í´ë¦­ (onclick="handleGeolocation()")

âœ“ onSuccessGeolocation(position)
  - ì—­í• : GPS ìœ„ì¹˜ íšë“ ì„±ê³µ ì‹œ ëŒ€í”¼ì†Œ ê²€ìƒ‰ ë° ê²°ê³¼ í‘œì‹œ
  - íŒŒë¼ë¯¸í„°: position (Geolocation Position ê°ì²´)
  - í˜¸ì¶œ í•¨ìˆ˜:
    - addMessage('bot', ...) - ìœ„ì¹˜ í™•ì¸ ë©”ì‹œì§€
    - searchSheltersByCoordinates(lat, lon) - ëŒ€í”¼ì†Œ ê²€ìƒ‰
    - haversine(lat1, lon1, lat2, lon2) - ê±°ë¦¬ ì¬ê³„ì‚°
    - displayLLMShelterResults(location, coords, shelters) - ê²°ê³¼ í‘œì‹œ
  - ì˜¤ë¥˜ ì²˜ë¦¬: ëŒ€í”¼ì†Œ ì—†ì„ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

âœ“ onErrorGeolocation(error)
  - ì—­í• : GPS ìœ„ì¹˜ íšë“ ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ì²˜ë¦¬ ë° UI ë³µì›
  - íŒŒë¼ë¯¸í„°: error (GeolocationPositionError ê°ì²´)
  - ì˜¤ë¥˜ ì½”ë“œ: 1(ê¶Œí•œ ê±°ë¶€), 2(ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€), 3(ì‹œê°„ ì´ˆê³¼)
  - í˜¸ì¶œ í•¨ìˆ˜: addMessage('bot', ...), setControlsDisabled(false), showActionButtons(true)

âœ“ haversine(lat1, lon1, lat2, lon2)
  - ì—­í• : Haversine ê³µì‹ì„ ì‚¬ìš©í•œ ë‘ ì§€ì  ê°„ êµ¬ë©´ ê±°ë¦¬ ê³„ì‚° (ë‹¨ìœ„: km)
  - íŒŒë¼ë¯¸í„°: lat1, lon1 (ì¶œë°œì§€ ì¢Œí‘œ), lat2, lon2 (ë„ì°©ì§€ ì¢Œí‘œ)
  - ë°˜í™˜: ê±°ë¦¬ (km, float)
  - ìˆ˜ì‹: R * 2 * atan2(âˆša, âˆš(1-a)), where R = 6371km (ì§€êµ¬ ë°˜ì§€ë¦„)

âœ“ toRad(degrees)
  - ì—­í• : ê°ë„(degree)ë¥¼ ë¼ë””ì•ˆ(radian)ìœ¼ë¡œ ë³€í™˜
  - íŒŒë¼ë¯¸í„°: degrees (ê°ë„)
  - ë°˜í™˜: degrees * (Ï€ / 180)

[5] ì±„íŒ… ì…ë ¥ ì²˜ë¦¬ í•¨ìˆ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ handleChatInput()
  - ì—­í• : ì±„íŒ… ì…ë ¥ì°½ì—ì„œ ë©”ì‹œì§€ ì „ì†¡ ì‹œ ì²˜ë¦¬ (LLM ìš°ì„  ì‚¬ìš©)
  - ì‚¬ìš©ì íŠ¸ë¦¬ê±°: 
    - ì „ì†¡ ë²„íŠ¼ í´ë¦­ (onclick="handleChatInput()")
    - Enter í‚¤ ì…ë ¥ (onkeydown ì´ë²¤íŠ¸)
  - ì²˜ë¦¬ ìˆœì„œ:
    1. ì…ë ¥ê°’ trim ë° ê²€ì¦
    2. "í˜„ìœ„ì¹˜" í‚¤ì›Œë“œ ê°ì§€ â†’ handleGeolocation() í˜¸ì¶œ
    3. LLM API ì‚¬ìš© ê°€ëŠ¥ ì‹œ â†’ extractLocationWithLLM(query) í˜¸ì¶œ
    4. ì‘ë‹µ íƒ€ì…ë³„ ë¶„ê¸°:
       - shelters ìˆìŒ â†’ displayLLMShelterResults() í˜¸ì¶œ
       - message ìˆìŒ â†’ ì¬ë‚œí–‰ë™ìš”ë ¹/ì¼ë°˜ëŒ€í™” ì‘ë‹µ í‘œì‹œ
    5. API ë¶ˆê°€ ì‹œ â†’ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
  - í˜¸ì¶œ í•¨ìˆ˜: 
    - handleGeolocation() (í˜„ìœ„ì¹˜ í‚¤ì›Œë“œ ê°ì§€ ì‹œ)
    - extractLocationWithLLM(query) (LLM ê²€ìƒ‰)
    - displayLLMShelterResults() (ëŒ€í”¼ì†Œ ê²°ê³¼ í‘œì‹œ)
    - addMessage(), setControlsDisabled(), showActionButtons()

[6] ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ displayLLMShelterResults(locationName, coords, shelters)
  - ì—­í• : ëŒ€í”¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì±„íŒ…ì°½ê³¼ ì§€ë„ì— í‘œì‹œ
  - íŒŒë¼ë¯¸í„°:
    - locationName: ê²€ìƒ‰ ìœ„ì¹˜ëª… (ì˜ˆ: "ê°•ë‚¨ì—­")
    - coords: [lat, lon] ë°°ì—´ (ê²€ìƒ‰ ì¤‘ì‹¬ ì¢Œí‘œ)
    - shelters: ëŒ€í”¼ì†Œ ê°ì²´ ë°°ì—´
  - ìƒì„± ìš”ì†Œ:
    - ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ ì •ë³´ ì¹´ë“œ (ì´ë¦„, ì£¼ì†Œ, ê±°ë¦¬, ìˆ˜ìš©ì¸ì›)
    - ì „ì²´ ëŒ€í”¼ì†Œ ëª©ë¡ (ë“œë¡­ë‹¤ìš´, <details> íƒœê·¸ ì‚¬ìš©)
    - ì¹´ì¹´ì˜¤ë§µ ë§í¬ ë²„íŠ¼ (ì™¸ë¶€ ì§€ë„ ì•± ì—°ë™)
  - í˜¸ì¶œ í•¨ìˆ˜: 
    - addMessage('bot', ..., true) - ê²°ê³¼ ë©”ì‹œì§€ ì¶”ê°€
    - showMapWithMultipleShelters(lat, lon, shelters, locationName) - ì§€ë„ í‘œì‹œ
    - setControlsDisabled(false), showActionButtons(true) - UI ë³µì›

[7] ì§€ë„ í‘œì‹œ í•¨ìˆ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ showMapWithMultipleShelters(centerLat, centerLon, shelters, locationName)
  - ì—­í• : ë„¤ì´ë²„ ì§€ë„ì— ê²€ìƒ‰ ìœ„ì¹˜ì™€ ì—¬ëŸ¬ ëŒ€í”¼ì†Œë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œ
  - íŒŒë¼ë¯¸í„°:
    - centerLat, centerLon: ê²€ìƒ‰ ì¤‘ì‹¬ ì¢Œí‘œ
    - shelters: ëŒ€í”¼ì†Œ ë°°ì—´
    - locationName: ê²€ìƒ‰ ìœ„ì¹˜ëª…
  - ì§€ë„ ìš”ì†Œ:
    - ì¤‘ì‹¬ì  ë§ˆì»¤ (íŒŒë€ìƒ‰ ë§í’ì„ , ê²€ìƒ‰ ìœ„ì¹˜)
    - ëŒ€í”¼ì†Œ ë§ˆì»¤ë“¤ (ë¹¨ê°„ìƒ‰ = ê°€ì¥ ê°€ê¹Œìš´, ê¸°ë³¸ = ë‚˜ë¨¸ì§€)
    - ì •ë³´ì°½ (InfoWindow): í´ë¦­ ì‹œ ëŒ€í”¼ì†Œ ìƒì„¸ ì •ë³´ í‘œì‹œ
  - ë„¤ì´ë²„ ë§µ API ì‚¬ìš©:
    - new naver.maps.Map() - ì§€ë„ ìƒì„±
    - new naver.maps.Marker() - ë§ˆì»¤ ìƒì„±
    - new naver.maps.InfoWindow() - ì •ë³´ì°½ ìƒì„±
    - map.fitBounds(bounds) - ëª¨ë“  ë§ˆì»¤ í¬í•¨í•˜ë„ë¡ ë·°í¬íŠ¸ ì¡°ì •
    - naver.maps.Event.addListener() - í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
  - í˜¸ì¶œ í•¨ìˆ˜: closeAllInfoWindows() - ê¸°ì¡´ ì •ë³´ì°½ ë‹«ê¸°
  - ì „ì—­ ë³€ìˆ˜ ìˆ˜ì •: map, userMarker, shelterMarkers[]

âœ“ closeAllInfoWindows()
  - ì—­í• : ì—´ë ¤ìˆëŠ” ëª¨ë“  ë„¤ì´ë²„ ì§€ë„ ì •ë³´ì°½ ë‹«ê¸°
  - ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©: openInfoWindows[] (ì •ë³´ì°½ ë°°ì—´)
  - ë™ì‘: ë°°ì—´ì˜ ëª¨ë“  InfoWindow.close() í˜¸ì¶œ í›„ ë°°ì—´ ì´ˆê¸°í™”

=================================================================================
[ì „ì—­ ë³€ìˆ˜]
=================================================================================
- API_BASE_URL: FastAPI ì„œë²„ ì£¼ì†Œ (ë™ì  ê°ì§€)
- USE_LLM: LLM ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ (boolean)
- API_AVAILABLE: ì„œë²„ ì—°ê²° ê°€ëŠ¥ ì—¬ë¶€ (boolean)
- map: ë„¤ì´ë²„ ì§€ë„ ê°ì²´ (naver.maps.Map)
- userMarker: ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ (naver.maps.Marker)
- shelterMarkers: ëŒ€í”¼ì†Œ ë§ˆì»¤ ë°°ì—´ (naver.maps.Marker[])
- openInfoWindows: ì—´ë¦° ì •ë³´ì°½ ë°°ì—´ (naver.maps.InfoWindow[])
- chatWindow: ì±„íŒ…ì°½ DOM ìš”ì†Œ (#chat-window)
- initialActions: ì´ˆê¸° ì•¡ì…˜ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (#initial-actions)
- chatInput: ì±„íŒ… ì…ë ¥ í•„ë“œ (#chat-input)
- sendBtn: ì „ì†¡ ë²„íŠ¼ (#send-btn)
- actionButtons: ì œì–´ ëŒ€ìƒ ë²„íŠ¼ ë°°ì—´ [geo-btn, send-btn]

=================================================================================
[í•¨ìˆ˜ í˜¸ì¶œ íë¦„ë„]
=================================================================================

[í˜ì´ì§€ ë¡œë“œ]
DOMContentLoaded
  â””â”€> checkApiStatus()
        â””â”€> updateLlmBadge()
  â””â”€> showActionButtons(true)
        â””â”€> setControlsDisabled(false)

[í˜„ìœ„ì¹˜ ê²€ìƒ‰]
handleGeolocation() [onclick]
  â””â”€> setControlsDisabled(true)
  â””â”€> addMessage('user', ...), addMessage('bot', ...)
  â””â”€> navigator.geolocation.getCurrentPosition()
        â”œâ”€> [ì„±ê³µ] onSuccessGeolocation(position)
        â”‚     â””â”€> searchSheltersByCoordinates(lat, lon)
        â”‚           â””â”€> [ë°±ì—”ë“œ] GET /api/shelters/nearest
        â”‚     â””â”€> haversine() (ê±°ë¦¬ ì¬ê³„ì‚°)
        â”‚     â””â”€> displayLLMShelterResults(location, coords, shelters)
        â”‚           â””â”€> addMessage('bot', ..., true)
        â”‚           â””â”€> showMapWithMultipleShelters()
        â”‚                 â””â”€> closeAllInfoWindows()
        â”‚                 â””â”€> new naver.maps.Marker() (ì—¬ëŸ¬ ê°œ)
        â”‚                 â””â”€> new naver.maps.InfoWindow() (í´ë¦­ ì´ë²¤íŠ¸)
        â”‚
        â””â”€> [ì‹¤íŒ¨] onErrorGeolocation(error)
              â””â”€> addMessage('bot', ...)
              â””â”€> setControlsDisabled(false)
              â””â”€> showActionButtons(true)

[ì±„íŒ… ì…ë ¥ ê²€ìƒ‰]
handleChatInput() [onclick / onkeydown]
  â”œâ”€> [í˜„ìœ„ì¹˜ í‚¤ì›Œë“œ] handleGeolocation() (ìœ„ì™€ ë™ì¼í•œ íë¦„)
  â”‚
  â”œâ”€> [ì¼ë°˜ ê²€ìƒ‰] extractLocationWithLLM(query)
  â”‚     â””â”€> [ë°±ì—”ë“œ] POST /api/location/extract
  â”‚     â””â”€> [ì‘ë‹µ: shelters ìˆìŒ] displayLLMShelterResults()
  â”‚           â””â”€> (ìœ„ì™€ ë™ì¼)
  â”‚     â””â”€> [ì‘ë‹µ: message ìˆìŒ] addMessage('bot', message) (ì¬ë‚œí–‰ë™ìš”ë ¹/ì¼ë°˜ëŒ€í™”)
  â”‚
  â””â”€> [API ë¶ˆê°€] addMessage('bot', ì—ëŸ¬ ë©”ì‹œì§€)

=================================================================================
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ ì°¾ê¸° ì±—ë´‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ë„¤ì´ë²„ ì§€ë„ API ìŠ¤í¬ë¦½íŠ¸: ì§€ë„(maps)ì™€ ì£¼ì†Œ ê²€ìƒ‰(geocoding) ëª¨ë“ˆì„ í•¨ê»˜ ë¡œë“œí•©ë‹ˆë‹¤. -->
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=lw2n4pvfl5&amp;submodules=panorama,geocoder,drawing,visualization"></script>
    <style>
        /* í°íŠ¸ ì„¤ì • ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ê¹”ë”í•œ ëª¨ë°”ì¼ ë·°) */
        #chat-window {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        #chat-window::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        /* ì§€ë„ ì»¨í…Œì´ë„ˆê°€ ë¡œë“œëœ í›„ ë‚´ë¶€ì˜ í…ìŠ¤íŠ¸ë¥¼ ì§€ìš°ê¸° ìœ„í•¨ */
        #map > div:only-child {
            display: none;
        }
        /* ë¡œë”© ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
        .disabled-control {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* [ì¶”ê°€ëœ ë¶€ë¶„] ì±—ë´‡ ì „ì²´ ì»¨í…Œì´ë„ˆ ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì • */
        #main-chat-container {
            background-image: url('http://googleusercontent.com/image_generation_content/0');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* [ìˆ˜ì •ëœ ë¶€ë¶„] ì±„íŒ…ì°½ ë°°ê²½ì— íˆ¬ëª…ë„ ì¶”ê°€í•˜ì—¬ ì´ë¯¸ì§€ ë³´ì´ê²Œ í•¨ */
        #chat-window {
             background-color: rgba(255, 255, 255, 0.7); /* í°ìƒ‰ ë°°ê²½ì— 70% íˆ¬ëª…ë„ ì ìš© */
        }
        /* [ìˆ˜ì •ëœ ë¶€ë¶„] ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë°°ê²½ì— íˆ¬ëª…ë„ ì¶”ê°€ */
        #control-panel {
             background-color: rgba(255, 255, 255, 0.85); /* í°ìƒ‰ ë°°ê²½ì— 85% íˆ¬ëª…ë„ ì ìš© */
        }
        
        /* LLM ìƒíƒœ í‘œì‹œ */
        .llm-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        .llm-on { background-color: #10B981; color: white; }
        .llm-off { background-color: #6B7280; color: white; }
    </style>

    </head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-white rounded-xl shadow-2xl flex flex-col h-[80vh] overflow-hidden">

        <header class="p-4 bg-red-600 text-white shadow-md rounded-t-xl">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold">ğŸš¨ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ ì°¾ê¸° ì±—ë´‡</h1>
                    <p class="text-xs mt-1 opacity-90">ë¯¼ë°©ìœ„ëŒ€í”¼ì‹œì„¤ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•ˆë‚´í•©ë‹ˆë‹¤.</p>
                </div>
                <div id="llm-status" class="llm-badge llm-off">LLM OFF</div>
            </div>
        </header>

        <!-- ì§€ë„ ì˜ì—­ (ë†’ì´ í™•ëŒ€) -->
        <div id="map" style="width:100%;height:150px;min-height:150px;">

        </div>

        <div id="chat-window" class="flex-grow p-4 space-y-4 overflow-y-auto bg-white">
            <div class="flex justify-start">
                <div class="bg-gray-100 text-gray-800 p-3 rounded-xl rounded-tl-none max-w-[80%] shadow-sm">
                    <p class="font-semibold mb-1">ğŸ›¡ï¸ ëŒ€í”¼ì†Œ ë„ìš°ë¯¸</p>
                    <p id="initial-message">ëŒ€í”¼ì†Œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
                </div>
            </div>
            </div>

        <div id="control-panel" class="p-4 bg-white border-t border-gray-200">

            <!-- 1. í˜„ìœ„ì¹˜ ë²„íŠ¼ -->
            <div id="initial-actions" class="flex flex-col space-y-2">
                <button id="geo-btn" onclick="handleGeolocation()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold transition duration-150 shadow-md disabled-control" disabled>
                    ğŸ“ í˜„ìœ„ì¹˜ë¡œ ì°¾ê¸° (GPS)
                </button>
            </div>

            <!-- 2. ëŒ€í™” ì…ë ¥ì°½ê³¼ ì „ì†¡ ë²„íŠ¼ -->
            <div id="chat-input-container" class="flex items-center space-x-2 mt-2">
                <input type="text" id="chat-input" placeholder="ì£¼ì†Œë‚˜ ê±´ë¬¼ëª…ìœ¼ë¡œ ëŒ€í”¼ì†Œë¥¼ ê²€ìƒ‰í•´ ë³´ì„¸ìš”."
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"
                       onkeydown="if(event.key === 'Enter') handleChatInput()">
                <button id="send-btn" onclick="handleChatInput()"
                        class="bg-red-600 text-white p-3 rounded-lg font-bold transition duration-150 hover:bg-red-700 shadow-md disabled-control" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.405Z" />
                    </svg>
                </button>
            </div>


        </div>

    </div>

    <script>
        // =================================================================
        // ì„¤ì •
        // =================================================================
        
        // API ì„œë²„ ì£¼ì†Œ ìë™ ê°ì§€
        const API_BASE_URL = (() => {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol; // http: ë˜ëŠ” https:
            const port = window.location.port || '8443'; // í˜„ì¬ í¬íŠ¸ ë˜ëŠ” ê¸°ë³¸ 8443
            
            // localhost, 127.0.0.1, ë˜ëŠ” ë¹ˆ ë¬¸ìì—´(íŒŒì¼ë¡œ ì—´ì—ˆì„ ë•Œ)ì¸ ê²½ìš°
            if (!hostname || hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '') {
                // íŒŒì¼ë¡œ ì—´ì—ˆì„ ë•ŒëŠ” HTTPS ì„œë²„ ì‚¬ìš©
                return 'https://127.0.0.1:8443';
            }
            
            // ê·¸ ì™¸ì˜ ê²½ìš° í˜„ì¬ í”„ë¡œí† ì½œê³¼ í¬íŠ¸ ì‚¬ìš© (HTTPS í™˜ê²½)
            return `${protocol}//${hostname}:${port}`;
        })();
        
        console.log('ğŸŒ API ì„œë²„ ì£¼ì†Œ:', API_BASE_URL);
        
        // LLM ì‚¬ìš© ì—¬ë¶€ (ì„œë²„ì—ì„œ í™•ì¸)
        let USE_LLM = false;
        let API_AVAILABLE = false;

        // 2. ë„¤ì´ë²„ ì§€ë„ ê°ì²´ ê´€ë ¨ ë³€ìˆ˜ ì„ ì–¸
        let map = null;
        let userMarker = null;
        let shelterMarkers = []; // ì—¬ëŸ¬ ëŒ€í”¼ì†Œ ë§ˆì»¤
        let openInfoWindows = []; // ì—´ë¦° ì •ë³´ì°½ ì¶”ì 

        const chatWindow = document.getElementById('chat-window');
        const initialActions = document.getElementById('initial-actions');
        const initialMessageEl = document.getElementById('initial-message');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const actionButtons = [
            document.getElementById('geo-btn'),
            sendBtn,
        ];
        
        // =================================================================
        // LLM API ì—°ë™ í•¨ìˆ˜
        // =================================================================
        
        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/status`);
                if (response.ok) {
                    const data = await response.json();
                    API_AVAILABLE = true;
                    USE_LLM = data.llm_available;
                    updateLlmBadge();
                    console.log('API ìƒíƒœ:', data);
                    return data;
                }
            } catch (error) {
                console.log('API ì„œë²„ ì—°ê²° ì‹¤íŒ¨, ë¡œì»¬ ëª¨ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤:', error);
                API_AVAILABLE = false;
                USE_LLM = false;
                updateLlmBadge();
            }
            return null;
        }
        
        function updateLlmBadge() {
            const badge = document.getElementById('llm-status');
            if (API_AVAILABLE && USE_LLM) {
                badge.className = 'llm-badge llm-on';
                badge.textContent = 'ğŸ¤– LLM ON';
            } else if (API_AVAILABLE) {
                badge.className = 'llm-badge llm-off';
                badge.textContent = 'ğŸ“ ê·œì¹™ ê¸°ë°˜';
            } else {
                badge.className = 'llm-badge llm-off';
                badge.textContent = 'ğŸ“‚ ë¡œì»¬ ëª¨ë“œ';
            }
        }
        
        async function extractLocationWithLLM(query) {
            /**
             * LLM APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì§€ëª…ì„ ì¶”ì¶œí•˜ê³  ëŒ€í”¼ì†Œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
             */
            if (!API_AVAILABLE) {
                return null;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/location/extract`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify({
                        query: query,
                        use_llm: USE_LLM
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('LLM ì‘ë‹µ:', data);
                    return data;
                }
            } catch (error) {
                console.error('LLM API í˜¸ì¶œ ì˜¤ë¥˜:', error);
            }
            return null;
        }

        // -------------------------------------------------------------------------
        // [í•µì‹¬ ê¸°ëŠ¥] ì„œë²„ API ê¸°ë°˜ ëŒ€í”¼ì†Œ ê²€ìƒ‰
        // -------------------------------------------------------------------------
        function setControlsDisabled(disabled) {
            actionButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = disabled;
                    btn.classList.toggle('disabled-control', disabled);
                    // í˜„ìœ„ì¹˜ ë²„íŠ¼ í˜¸ë²„ ìŠ¤íƒ€ì¼
                    if (btn.id === 'geo-btn') {
                       btn.classList.toggle('hover:bg-blue-700', !disabled);
                    }
                    // ì „ì†¡ ë²„íŠ¼ í˜¸ë²„ ìŠ¤íƒ€ì¼
                    if (btn.id === 'send-btn') {
                       btn.classList.toggle('hover:bg-red-700', !disabled);
                    }
                }
            });
            // ì±„íŒ… ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™”
            if (chatInput) {
                chatInput.disabled = disabled;
            }
        }

        // ========================================================================
        // ì„œë²„ API í˜¸ì¶œ: ì¢Œí‘œ ê¸°ë°˜ ëŒ€í”¼ì†Œ ê²€ìƒ‰
        // FastAPI ì„œë²„ì˜ /api/shelters/nearest ì—”ë“œí¬ì¸íŠ¸ì™€ í†µì‹ 
        // ========================================================================
        async function searchSheltersByCoordinates(lat, lon, locationName = "í˜„ì¬ ìœ„ì¹˜") {
            try {
                console.log('[DEBUG] API í˜¸ì¶œ ì‹œì‘:', `${API_BASE_URL}/api/shelters/nearest?lat=${lat}&lon=${lon}&k=5`);
                
                // 1. FastAPI ì„œë²„ì— HTTP GET ìš”ì²­ ì „ì†¡
                // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°: lat(ìœ„ë„), lon(ê²½ë„), k(ë°˜í™˜í•  ëŒ€í”¼ì†Œ ê°œìˆ˜)
                const response = await fetch(`${API_BASE_URL}/api/shelters/nearest?lat=${lat}&lon=${lon}&k=5`);
                
                console.log('[DEBUG] ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
                
                // 2. HTTP ì‘ë‹µ ìƒíƒœ í™•ì¸
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }
                
                // 3. JSON ì‘ë‹µ ë°ì´í„° íŒŒì‹±
                const data = await response.json();
                console.log('[DEBUG] ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
                // ì˜ˆìƒ ì‘ë‹µ í˜•ì‹: { user_location: {lat, lon}, shelters: [...], total_count: number }
                
                // 4. ì„œë²„ ì‘ë‹µ ë°ì´í„° ì •ê·œí™”
                // ì„œë²„ì—ì„œ ì˜¤ëŠ” ë°ì´í„° í˜•ì‹ì„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸° ì‰¬ìš´ í˜•íƒœë¡œ ë³€í™˜
                const shelters = data.shelters.map(shelter => ({
                    ...shelter,                        // ê¸°ì¡´ ì†ì„±ë“¤ ìœ ì§€
                    distance: shelter.distance || 0,   // distance í•„ë“œ ë³´ì¥
                    capacity: shelter.capacity || 0    // capacity í•„ë“œ ë³´ì¥ (ìˆ˜ìš©ì¸ì›)
                }));
                
                console.log('[DEBUG] ì •ê·œí™”ëœ ëŒ€í”¼ì†Œ ë°ì´í„°:', shelters);
                return shelters;
            } catch (error) {
                // 5. ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜ ì²˜ë¦¬
                console.error('[ERROR] ì¢Œí‘œ ê¸°ë°˜ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                return null; // ì˜¤ë¥˜ ì‹œ null ë°˜í™˜í•˜ì—¬ ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í•¨
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addMessage(sender, text, isResult = false) {
            const messageWrapper = document.createElement('div');
            const messageContent = document.createElement('div');

            if (sender === 'user') {
                messageWrapper.className = 'flex justify-end';
                messageContent.className = 'bg-red-100 text-gray-900 p-3 rounded-xl rounded-tr-none max-w-[80%] shadow-sm';
            } else {
                messageWrapper.className = 'flex justify-start';
                let bgColor = isResult ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-800';
                messageContent.className = `${bgColor} p-3 rounded-xl rounded-tl-none max-w-[80%] shadow-sm`;
                if (!isResult) {
                     messageContent.innerHTML = `<p class="font-semibold mb-1">ğŸ›¡ï¸ ëŒ€í”¼ì†Œ ë„ìš°ë¯¸</p>${text}`;
                } else {
                     messageContent.innerHTML = `<p class="font-bold mb-1">âœ… ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ ê²°ê³¼</p>${text}`;
                }
            }

            if (sender === 'user') {
                messageContent.innerHTML = text;
            }

            messageWrapper.appendChild(messageContent);
            chatWindow.appendChild(messageWrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine) - í´ë¼ì´ì–¸íŠ¸ í‘œì‹œìš©
        const EARTH_RADIUS_KM = 6371;
        function toRad(degrees) { return degrees * (Math.PI / 180); }
        function haversine(lat1, lon1, lat2, lon2) {
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const rLat1 = toRad(lat1);
            const rLat2 = toRad(lat2);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.sin(dLon / 2) * Math.sin(dLon / 2) *
                      Math.cos(rLat1) * Math.cos(rLat2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return EARTH_RADIUS_KM * c;
        }

        // showMap í•¨ìˆ˜ ì œê±°ë¨ (showMapWithMultipleShelters ì‚¬ìš©)

        // ========================================================================
        // GPS ìœ„ì¹˜ ì •ë³´ íšë“ ì‹¤íŒ¨ ì²˜ë¦¬ í•¨ìˆ˜
        // navigator.geolocation.getCurrentPositionì˜ ë‘ ë²ˆì§¸ ì½œë°± (ì‹¤íŒ¨ ì‹œ í˜¸ì¶œ)
        // ========================================================================
        function onErrorGeolocation(error) {
            console.log('[ERROR] Geolocation ì˜¤ë¥˜ ë°œìƒ:', error);
            
            // GPS ì˜¤ë¥˜ ì½”ë“œì— ë”°ë¥¸ ìƒì„¸ ë©”ì‹œì§€ ìƒì„±
            let errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            
            // error.code ê°’ë³„ ì˜ë¯¸:
            // 1 (PERMISSION_DENIED): ì‚¬ìš©ìê°€ ìœ„ì¹˜ ì •ë³´ ì œê³µì„ ê±°ë¶€í•¨
            // 2 (POSITION_UNAVAILABLE): ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ìœ¼ë¡œ ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€
            // 3 (TIMEOUT): ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ ì´ˆê³¼
            if (error.code === 1) errorMessage += ' (ê¶Œí•œ ê±°ë¶€ë¨)';
            else if (error.code === 2) errorMessage += ' (ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€)';
            else if (error.code === 3) errorMessage += ' (ì‹œê°„ ì´ˆê³¼)';

            console.log('[ERROR] Geolocation ì—ëŸ¬ ë©”ì‹œì§€:', errorMessage);
            
            // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— í‘œì‹œ
            addMessage('bot', `<span class="text-red-500 font-bold">${errorMessage}</span>`, false);
            
            // UI ë³µì›: ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™” ë° ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
            setControlsDisabled(false); // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            showActionButtons(true);     // ì´ˆê¸° ì•¡ì…˜ ë²„íŠ¼ë“¤ ë‹¤ì‹œ í‘œì‹œ
        }

        // ========================================================================
        // GPS ìœ„ì¹˜ ì •ë³´ íšë“ ì„±ê³µ ì²˜ë¦¬ í•¨ìˆ˜ (ë©”ì¸ ë¡œì§)
        // navigator.geolocation.getCurrentPositionì˜ ì²« ë²ˆì§¸ ì½œë°± (ì„±ê³µ ì‹œ í˜¸ì¶œ)
        // ========================================================================
        async function onSuccessGeolocation(position) {
            console.log('[DEBUG] onSuccessGeolocation í•¨ìˆ˜ ì‹œì‘, ìœ„ì¹˜ ë°ì´í„°:', position);
            
            // 1. GPSì—ì„œ ë°›ì€ ì¢Œí‘œ ì •ë³´ ì¶”ì¶œ
            const latitude = position.coords.latitude;   // ìœ„ë„ (ë‚¨ë¶ ìœ„ì¹˜)
            const longitude = position.coords.longitude; // ê²½ë„ (ë™ì„œ ìœ„ì¹˜)

            console.log('[DEBUG] ì¶”ì¶œëœ ì¢Œí‘œ:', {latitude, longitude});

            // 2. ì‚¬ìš©ìì—ê²Œ ìœ„ì¹˜ ì •ë³´ íšë“ ì™„ë£Œ ì•Œë¦¼ (ì†Œìˆ˜ì  4ìë¦¬ê¹Œì§€ í‘œì‹œ)
            addMessage('bot', `í˜„ì¬ ìœ„ì¹˜ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ìœ„ë„: ${latitude.toFixed(4)}, ê²½ë„: ${longitude.toFixed(4)}`, false);
            
            // 3. ëŒ€í”¼ì†Œ ê²€ìƒ‰ ì‹œì‘ ì•Œë¦¼
            addMessage('bot', 'ğŸ” ì£¼ë³€ ëŒ€í”¼ì†Œë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...', false);
            
            console.log('[DEBUG] API í˜¸ì¶œ ì¤€ë¹„ ì¤‘...');
            
            // 4. ì„œë²„ API í˜¸ì¶œ: í˜„ì¬ ì¢Œí‘œ ê¸°ì¤€ ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ 5ê°œ ê²€ìƒ‰
            // searchSheltersByCoordinates í•¨ìˆ˜ê°€ FastAPI ì„œë²„ì˜ /api/shelters/nearest ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            const shelters = await searchSheltersByCoordinates(latitude, longitude, "í˜„ì¬ ìœ„ì¹˜");
            console.log('[DEBUG] ì„œë²„ì—ì„œ ë°›ì€ ëŒ€í”¼ì†Œ ë°ì´í„°:', shelters);
            
            // 5. ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬
            if (shelters && shelters.length > 0) {
                // 5-1. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •í™•í•œ ê±°ë¦¬ ì¬ê³„ì‚° (í•˜ë²„ì‚¬ì¸ ê³µì‹ ì‚¬ìš©)
                // ì„œë²„ì—ì„œë„ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ì§€ë§Œ, í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë” ì •í™•í•œ ê±°ë¦¬ ê³„ì‚°
                shelters.forEach(shelter => {
                    shelter.distance = haversine(latitude, longitude, shelter.lat, shelter.lon);
                });
                
                // 5-2. ê±°ë¦¬ìˆœìœ¼ë¡œ ì •ë ¬ (ê°€ê¹Œìš´ ìˆœì„œëŒ€ë¡œ)
                shelters.sort((a, b) => a.distance - b.distance);
                
                // 5-3. ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                addMessage('bot', `âœ… í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ ëŒ€í”¼ì†Œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤! (ì´ ${shelters.length}ê°œ)`, false);
                
                // 5-4. ëŒ€í”¼ì†Œ ê²°ê³¼ë¥¼ ì§€ë„ì™€ í•¨ê»˜ í‘œì‹œ
                // displayLLMShelterResults: ëŒ€í”¼ì†Œ ëª©ë¡ì„ ì±„íŒ…ì°½ì— í‘œì‹œí•˜ê³  ë„¤ì´ë²„ ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ
                displayLLMShelterResults("í˜„ì¬ ìœ„ì¹˜", [latitude, longitude], shelters);
            } else {
                // 6. ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°
                addMessage('bot', `<span class="text-red-500 font-bold">ì£¼ë³€ì— ëŒ€í”¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`, false);
                
                // UI ë³µì›: ë²„íŠ¼ í™œì„±í™” ë° ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
                setControlsDisabled(false);
                showActionButtons(true);
            }
        }

        // ========================================================================
        // í˜„ìœ„ì¹˜ í•¸ë“¤ëŸ¬ - "ğŸ“ í˜„ìœ„ì¹˜ë¡œ ì°¾ê¸° (GPS)" ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” ë©”ì¸ í•¨ìˆ˜
        // ========================================================================
        function handleGeolocation() {
            console.log('[DEBUG] handleGeolocation í•¨ìˆ˜ ì‹œì‘');
            
            // 1. UI ì œì–´: ëª¨ë“  ë²„íŠ¼ê³¼ ì…ë ¥ì°½ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            setControlsDisabled(true);
            
            // 2. UI ì œì–´: ì´ˆê¸° ì•¡ì…˜ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸° (í˜„ìœ„ì¹˜/ì±„íŒ…ì…ë ¥ë§Œ ë‚¨ê¹€)
            initialActions.classList.add('hidden');
            
            // 3. ì±„íŒ… UI: ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ í´ë¦­í–ˆë‹¤ëŠ” ë©”ì‹œì§€ í‘œì‹œ
            addMessage('user', 'ğŸ“ í˜„ìœ„ì¹˜ë¡œ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œë¥¼ ê²€ìƒ‰í•´ ì¤˜.');
            
            // 4. ì±„íŒ… UI: GPS ìœ„ì¹˜ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì´ë¼ëŠ” ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
            addMessage('bot', 'GPSë¥¼ í†µí•´ í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', false);

            // 5. GPS ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œì‘
            if (navigator.geolocation) {
                console.log('[DEBUG] Geolocation API ì§€ì›ë¨. getCurrentPosition í˜¸ì¶œ ì‹œì‘');
                // ë¸Œë¼ìš°ì €ê°€ Geolocation APIë¥¼ ì§€ì›í•˜ëŠ” ê²½ìš°
                // - getCurrentPosition: í˜„ì¬ ìœ„ì¹˜ë¥¼ í•œ ë²ˆë§Œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
                // - ì„±ê³µ ì‹œ: onSuccessGeolocation ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
                // - ì‹¤íŒ¨ ì‹œ: onErrorGeolocation ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
                navigator.geolocation.getCurrentPosition(onSuccessGeolocation, onErrorGeolocation);
            } else {
                console.log('[ERROR] Geolocation API ì§€ì›ë˜ì§€ ì•ŠìŒ');
                // ë¸Œë¼ìš°ì €ê°€ Geolocation APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš° (ë§¤ìš° ì˜¤ë˜ëœ ë¸Œë¼ìš°ì €)
                addMessage('bot', '<span class="text-red-500 font-bold">ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>', false);
                setControlsDisabled(false);  // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                showActionButtons(true);     // ì´ˆê¸° ë²„íŠ¼ë“¤ ë‹¤ì‹œ í‘œì‹œ
            }
        }

        // handleAddressSearch í•¨ìˆ˜ ì œê±°ë¨ (LLM ê¸°ë°˜ ì±„íŒ… ì…ë ¥ìœ¼ë¡œ ì™„ì „ ëŒ€ì²´)

        // [ìˆ˜ì •ëœ í•¨ìˆ˜] ì±„íŒ… ì…ë ¥ ì²˜ë¦¬ - LLM ìš°ì„  ì‚¬ìš©
        async function handleChatInput() {
            const rawQuery = chatInput.value.trim();
            chatInput.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
            chatInput.focus(); // í¬ì»¤ìŠ¤ ìœ ì§€

            if (rawQuery === '') {
                return;
            }

            // 1. í˜„ìœ„ì¹˜ í‚¤ì›Œë“œ ì²˜ë¦¬ (ê°€ì¥ ë†’ì€ ìš°ì„ ìˆœìœ„)
            // 'í˜„ìœ„ì¹˜', 'í˜„ì¬ ìœ„ì¹˜', 'ì—¬ê¸°', 'ë‚´ ìœ„ì¹˜' ë“±ì„ í¬í•¨í•˜ë©´ GPS ê²€ìƒ‰
            if (rawQuery.includes('í˜„ìœ„ì¹˜') || rawQuery.includes('í˜„ì¬ ìœ„ì¹˜') || rawQuery.includes('ì—¬ê¸°') || rawQuery.includes('ë‚´ ìœ„ì¹˜')) {
                handleGeolocation();
                return;
            }
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessage('user', rawQuery, false);
            setControlsDisabled(true);
            initialActions.classList.add('hidden');

            // 2. LLM API ì‚¬ìš© ì‹œë„ (APIê°€ ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš°)
            if (API_AVAILABLE) {
                addMessage('bot', `ğŸ¤– "${rawQuery}"ì—ì„œ ìœ„ì¹˜ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...`, false);
                
                const llmResult = await extractLocationWithLLM(rawQuery);
                
                console.log('[DEBUG] llmResult:', llmResult);
                
                if (llmResult && llmResult.success) {
                    const shelters = llmResult.shelters || [];
                    const message = llmResult.message || "";
                    
                    console.log('[DEBUG] success=true, shelters ê°œìˆ˜:', shelters.length, 'message:', message);
                    
                    // CASE 1: ëŒ€í”¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš° (find_shelter)
                    if (shelters.length > 0) {
                        const locationName = llmResult.location;
                        const coords = llmResult.coordinates;
                        console.log('[DEBUG] ëŒ€í”¼ì†Œ ê²€ìƒ‰ - location:', locationName, 'coords:', coords);
                        addMessage('bot', `âœ… "${locationName}" ì£¼ë³€ ëŒ€í”¼ì†Œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!`, false);
                        displayLLMShelterResults(locationName, coords, shelters);
                        return;
                    }
                    
                    // CASE 2: ì¬ë‚œí–‰ë™ìš”ë ¹ ë˜ëŠ” ì¼ë°˜ëŒ€í™” ì‘ë‹µ (disaster_guide, general_chat)
                    if (message) {
                        // ë©”ì‹œì§€ë¥¼ ì¤„ë°”ê¿ˆ ì²˜ë¦¬í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
                        const formattedMessage = message.replace(/\n/g, '<br>');
                        addMessage('bot', `<div class="text-white font-medium leading-relaxed bg-gray-800 bg-opacity-50 p-4 rounded-lg">${formattedMessage}</div>`, false);
                        setControlsDisabled(false);
                        showActionButtons(true);
                        return;
                    }
                    
                    // CASE 3: successì´ì§€ë§Œ sheltersë„ ì—†ê³  messageë„ ì—†ëŠ” ê²½ìš° (ì˜ˆì™¸)
                    addMessage('bot', 'âš ï¸ ì‘ë‹µì„ ë°›ì•˜ì§€ë§Œ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', false);
                    setControlsDisabled(false);
                    showActionButtons(true);
                    return;
                    
                } else if (llmResult && !llmResult.success) {
                    // LLMì´ ì‹¤íŒ¨í•œ ê²½ìš°
                    const errorMessage = llmResult.message || "ì§€ëª…ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                    
                    // ë„¤ì´ë²„ APIë¡œ í´ë°±í•˜ì§€ ì•Šê³  ì—ëŸ¬ ë©”ì‹œì§€ë§Œ í‘œì‹œ
                    addMessage('bot', `<span class="text-yellow-300">âš ï¸ ${errorMessage}</span>`, false);
                    setControlsDisabled(false);
                    showActionButtons(true);
                    return;
                }
            }

            // 3. APIê°€ ì—†ëŠ” ê²½ìš°: ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            addMessage('bot', '<span class="text-red-300">âš ï¸ ì„œë²„ APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</span>', false);
            setControlsDisabled(false);
            showActionButtons(true);
        }
        
        // LLM ê²°ê³¼ë¡œ ëŒ€í”¼ì†Œ í‘œì‹œ
        function displayLLMShelterResults(locationName, coords, shelters) {
            console.log('=== displayLLMShelterResults í˜¸ì¶œ ===');
            console.log('locationName:', locationName);
            console.log('coords:', coords);
            console.log('coords[0] (lat):', coords[0]);
            console.log('coords[1] (lon):', coords[1]);
            console.log('shelters:', shelters);
            
            if (!shelters || shelters.length === 0) {
                addMessage('bot', `<span class="text-red-500 font-bold">"${locationName}" ê·¼ì²˜ì— ëŒ€í”¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`, false);
                setControlsDisabled(false);
                showActionButtons(true);
                return;
            }
            
            // ì²« ë²ˆì§¸ ëŒ€í”¼ì†Œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²°ê³¼ í‘œì‹œ (ê°€ì¥ ê°€ê¹Œìš´)
            const nearestShelter = shelters[0];
            
            // ê±°ë¦¬ í‘œì‹œ (APIì—ì„œ distance í•„ë“œ ì œê³µ)
            const distanceText = nearestShelter.distance 
                ? `<p class="mt-2 text-md">ğŸ“ ê²€ìƒ‰ ìœ„ì¹˜ì—ì„œ <span class="text-yellow-300 font-bold">${nearestShelter.distance.toFixed(2)} km</span> ê±°ë¦¬</p>`
                : '';
            
            // ëª¨ë“  ëŒ€í”¼ì†Œ ëª©ë¡ ìƒì„± (ë“œë¡­ë‹¤ìš´ìš©)
            let shelterListHtml = '';
            shelters.forEach((shelter, idx) => {
                const distText = shelter.distance ? `${shelter.distance.toFixed(2)}km` : '';
                const badge = idx === 0 ? 'ğŸ† ' : `${idx + 1}. `;
                shelterListHtml += `
                    <div class="mt-1 text-xs ${idx === 0 ? 'font-bold text-yellow-300' : 'opacity-80'}">
                        ${badge}${shelter.name} (${distText})
                        <a href="https://map.kakao.com/link/map/${encodeURIComponent(shelter.name)},${shelter.lat},${shelter.lon}" 
                           target="_blank" class="ml-1 text-blue-300 hover:text-blue-100">ğŸ”—</a>
                    </div>
                `;
            });
            
            // ê²€ìƒ‰ ìœ„ì¹˜ ì¤‘ì‹¬ ì¹´ì¹´ì˜¤ë§µ ë§í¬ (ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ)
            const kakaoMapUrl = `https://map.kakao.com/link/map/${encodeURIComponent(locationName)},${coords[0]},${coords[1]}`;
            
            const message = `
                <p class="text-lg font-bold">${nearestShelter.name}</p>
                <p class="text-sm">(${nearestShelter.address})</p>
                ${distanceText}
                <p class="mt-1 text-md">ìˆ˜ìš©ì¸ì›: <span class="text-yellow-300 font-bold">${nearestShelter.capacity.toLocaleString()}ëª…</span></p>
                <p class="mt-1 text-sm opacity-80">ğŸ¢ ì´ ${shelters.length}ê°œ ëŒ€í”¼ì†Œ í‘œì‹œë¨</p>
                <details class="mt-2">
                    <summary class="cursor-pointer text-sm text-blue-300 hover:text-blue-100">ğŸ“‹ ì „ì²´ ëŒ€í”¼ì†Œ ëª©ë¡ ë³´ê¸°</summary>
                    <div class="mt-1 ml-2 max-h-40 overflow-y-auto">
                        ${shelterListHtml}
                    </div>
                </details>
                <p class="mt-2">
                    <a href="${kakaoMapUrl}" target="_blank" class="inline-block bg-yellow-500 text-gray-900 px-4 py-2 rounded-lg text-sm font-bold hover:bg-yellow-600 transition duration-150">
                        ğŸ—ºï¸ ì¹´ì¹´ì˜¤ë§µì—ì„œ í¬ê²Œ ë³´ê¸°
                    </a>
                </p>
                <p class="mt-1 text-xs opacity-60">ğŸ’¡ ìœ„ ë§í¬ëŠ” ê²€ìƒ‰ ìœ„ì¹˜ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ë¥¼ ì—½ë‹ˆë‹¤. ê° ëŒ€í”¼ì†Œ ë§í¬(ğŸ”—)ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
            `;
            addMessage('bot', message, true);
            
            // ì§€ë„ì— í‘œì‹œ (ì—¬ëŸ¬ ëŒ€í”¼ì†Œ)
            showMapWithMultipleShelters(coords[0], coords[1], shelters, locationName);
            
            setControlsDisabled(false);
            showActionButtons(true);
        }
        
        // ëª¨ë“  ì •ë³´ì°½ ë‹«ê¸°
        function closeAllInfoWindows() {
            openInfoWindows.forEach(iw => iw.close());
            openInfoWindows = [];
        }
        
        // ì—¬ëŸ¬ ëŒ€í”¼ì†Œë¥¼ ì§€ë„ì— í‘œì‹œ
        function showMapWithMultipleShelters(centerLat, centerLon, shelters, locationName) {
            if (typeof naver === 'undefined' || !naver.maps) {
                console.log("ë„¤ì´ë²„ ë§µ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }
            
            const mapContainer = document.getElementById('map');
            const centerPos = new naver.maps.LatLng(centerLat, centerLon);
            
            if (!map) {
                map = new naver.maps.Map('map', {
                    center: centerPos,
                    zoom: 14
                });
                
                // ì§€ë„ í´ë¦­ ì‹œ ëª¨ë“  ì •ë³´ì°½ ë‹«ê¸°
                naver.maps.Event.addListener(map, 'click', () => {
                    closeAllInfoWindows();
                });
            } else {
                // ì§€ë„ í¬ê¸° ê°•ì œ ê°±ì‹ 
                map.setSize(new naver.maps.Size(mapContainer.offsetWidth, mapContainer.offsetHeight));
                map.setCenter(centerPos);
                map.setZoom(14);
            }
            
            // ê¸°ì¡´ ì •ë³´ì°½ ëª¨ë‘ ë‹«ê¸°
            closeAllInfoWindows();
            
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            if (userMarker) userMarker.setMap(null);
            shelterMarkers.forEach(m => m.setMap(null));
            shelterMarkers = [];
            
            // ì¤‘ì‹¬ì  ë§ˆì»¤ (ê²€ìƒ‰ ìœ„ì¹˜) - ë§í’ì„  ìŠ¤íƒ€ì¼
            const displayName = locationName.length > 6 ? locationName.slice(0, 6) + '..' : locationName;
            userMarker = new naver.maps.Marker({
                map: map,
                position: centerPos,
                icon: {
                    content: `
                        <div class="location-marker-container" style="position:relative;display:inline-flex;flex-direction:column;align-items:center;">
                            <div style="background-color:#4299E1;color:white;padding:6px 10px;border-radius:12px;font-size:12px;font-weight:bold;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.3);">
                                ğŸ“ ${displayName}
                            </div>
                            <div style="width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:10px solid #4299E1;margin-top:-1px;"></div>
                        </div>
                    `,
                    size: new naver.maps.Size(100, 50),
                    anchor: new naver.maps.Point(50, 50)
                },
                title: locationName
            });
            
            // ëŒ€í”¼ì†Œ ë§ˆì»¤ë“¤
            const bounds = new naver.maps.LatLngBounds(centerPos, centerPos);
            
            shelters.forEach((shelter, index) => {
                const shelterPos = new naver.maps.LatLng(shelter.lat, shelter.lon);
                bounds.extend(shelterPos);
                
                // ì²« ë²ˆì§¸ ëŒ€í”¼ì†Œ(ê°€ì¥ ê°€ê¹Œìš´)ëŠ” ë¹¨ê°„ìƒ‰ ë§ˆì»¤, ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ ë§ˆì»¤
                const isNearest = index === 0;
                const markerOptions = {
                    map: map,
                    position: shelterPos
                };
                
                // ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†ŒëŠ” ë¹¨ê°„ìƒ‰ ë§ˆì»¤ ì•„ì´ì½˜ ì‚¬ìš©
                if (isNearest) {
                    markerOptions.icon = {
                        url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                        size: new naver.maps.Size(32, 32),
                        anchor: new naver.maps.Point(16, 32)
                    };
                }
                
                const marker = new naver.maps.Marker(markerOptions);
                
                // í´ë¦­ ì‹œ ì •ë³´ì°½ í‘œì‹œ
                const distanceInfo = shelter.distance 
                    ? `<span style="font-size:11px;color:#2563EB;">ê±°ë¦¬: ${shelter.distance.toFixed(2)}km</span><br>` 
                    : '';
                const nearestBadge = isNearest 
                    ? `<span style="display:inline-block;background:#E53E3E;color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-bottom:4px;">ğŸ† ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ</span><br>` 
                    : '';
                const infoWindow = new naver.maps.InfoWindow({
                    content: `
                        <div style="padding:10px;max-width:200px;">
                            ${nearestBadge}
                            <strong>${shelter.name}</strong><br>
                            <span style="font-size:12px;color:#666;">${shelter.address}</span><br>
                            ${distanceInfo}
                            <span style="font-size:11px;color:#E53E3E;">ìˆ˜ìš©ì¸ì›: ${shelter.capacity.toLocaleString()}ëª…</span>
                        </div>
                    `
                });
                
                naver.maps.Event.addListener(marker, 'click', () => {
                    // ê¸°ì¡´ ì •ë³´ì°½ ëª¨ë‘ ë‹«ê³  ìƒˆ ì •ë³´ì°½ ì—´ê¸°
                    closeAllInfoWindows();
                    infoWindow.open(map, marker);
                    openInfoWindows.push(infoWindow);
                });
                
                shelterMarkers.push(marker);
            });
            
            // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ë·°í¬íŠ¸ ì¡°ì •
            map.fitBounds(bounds, { padding: 50 });
            
            // ì§€ë„ í¬ê¸° ê°•ì œ ê°±ì‹  (fitBounds í›„ ì§€ì—° ì‹¤í–‰)
            setTimeout(() => {
                const mapContainer = document.getElementById('map');
                if (map && mapContainer) {
                    map.setSize(new naver.maps.Size(mapContainer.offsetWidth, mapContainer.offsetHeight));
                }
            }, 100);
            
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }


        // ë²„íŠ¼ í‘œì‹œ í•¨ìˆ˜
        function showActionButtons(enableControls = true) {
            // API ì‚¬ìš© ê°€ëŠ¥í•˜ë©´ ë²„íŠ¼ í‘œì‹œ
            if (enableControls && API_AVAILABLE) {
                initialActions.classList.remove('hidden');
            } else {
                initialActions.classList.add('hidden');
            }

            // ì»¨íŠ¸ë¡¤ëŸ¬ í™œì„±í™”
            if (API_AVAILABLE) {
                setControlsDisabled(!enableControls);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // API ìƒíƒœ í™•ì¸
            const apiStatus = await checkApiStatus();
            
            if (API_AVAILABLE) {
                initialMessageEl.innerHTML = '<span class="text-purple-500 text-sm font-semibold">ì €ëŠ” MCKì…ë‹ˆë‹¤ ğŸ¤–</span><br><span class="text-blue-600 font-bold">ğŸš¨ ê¸´ê¸‰ ìƒí™© ì‹œ ëŒ€í”¼ì†Œì™€ ì¬ë‚œ í–‰ë™ìš”ë ¹ì„ ì•ˆë‚´í•©ë‹ˆë‹¤!</span><br><span class="text-gray-600">ì£¼ì†Œë‚˜ ì¥ì†Œëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ "í˜„ìœ„ì¹˜" ë²„íŠ¼ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œë¥¼ ì°¾ì•„ë³´ì„¸ìš”.</span>';
                setControlsDisabled(false);
                showActionButtons(true);
                chatInput.focus();
            } else {
                initialMessageEl.innerHTML = '<span class="text-red-500 font-bold">âš ï¸ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. FastAPI ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</span>';
            }
        });

    </script>

</body>
</html>