<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ ì°¾ê¸° ì±—ë´‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=lw2n4pvfl5&submodules=panorama,geocoder,drawing,visualization"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        #chat-window::-webkit-scrollbar { display: none; }
        #chat-window { scrollbar-width: none; -ms-overflow-style: none; }
        .disabled-control { opacity: 0.5; cursor: not-allowed; }
        .llm-badge { padding: 4px 10px; border-radius: 14px; font-size: 11px; font-weight: bold; }
        .llm-on { background-color: #10B981; color: white; }
        .llm-off { background-color: #6B7280; color: white; }
        .llm-on {background-color: #10B981;color: #ffffff;}
        .llm-off {background-color: #6b7280;color: #ffffff;}
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-2 md:p-6">

<div class="w-full max-w-6xl bg-white shadow-2xl rounded-2xl overflow-hidden grid md:grid-cols-2">

    <!-- left : map + panorama -->
    <div class="flex flex-col bg-gray-200 h-[250px] md:h-[85vh]">
        <header class="flex-shrink-0 p-4 bg-red-600 text-white flex justify-between items-center shadow-md">
            <div>
                <h1 class="text-lg font-bold">ğŸš¨ ì¬ë‚œ ì•ˆì „ ì±—ë´‡</h1>
                <p class="text-[10px] opacity-90">ë¯¼ë°©ìœ„ëŒ€í”¼ì‹œì„¤ ì •ë³´ ê¸°ë°˜</p>
            </div>
            <div id="llm-status" class="llm-badge llm-off">LLM OFF</div>
        </header>
        <!-- ìƒë‹¨: ì§€ë„ (50%) -->
        <div id="map" class="w-full" style="height: 50%;"></div>
        <!-- í•˜ë‹¨: íŒŒë…¸ë¼ë§ˆ (50%) -->
        <div id="pano" class="w-full bg-gray-800 relative" style="height: 50%;">
            <div id="pano-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm">
                ğŸ“· ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ íŒŒë…¸ë¼ë§ˆê°€ í‘œì‹œë©ë‹ˆë‹¤
            </div>
        </div>
    </div>

    <!-- right : chat -->
    <div class="flex flex-col h-[250px] md:h-[85vh] bg-white">
        <div id="chat-window" class="flex-1 min-h-0 p-6 space-y-4 overflow-y-auto bg-white">
            <div class="flex justify-start">
                <div class="bg-gray-100 text-gray-800 p-4 rounded-2xl max-w-[80%] shadow-sm">
                    <p class="font-semibold mb-1">ğŸ›¡ï¸ ëŒ€í”¼ì†Œ ë„ìš°ë¯¸</p>
                    <p id="initial-message">ëŒ€í”¼ì†Œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
                </div>
            </div>
        </div>

        <!-- control panel -->
        <div id="control-panel" class="flex-shrink-0 p-4 bg-gray-50 border-t border-gray-300 flex flex-col gap-3 shadow-md">
            <button id="geo-btn" onclick="handleGeolocation()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl disabled-control"
                disabled>ğŸ“ í˜„ìœ„ì¹˜ë¡œ ì°¾ê¸° (GPS)</button>

            <div class="flex gap-2">
                <input id="chat-input"
                    type="text"
                    placeholder="ì£¼ì†Œ / ê±´ë¬¼ëª… / 'í˜„ìœ„ì¹˜' ì…ë ¥"
                    class="flex-grow border border-gray-300 rounded-xl p-3 focus:ring-emerald-500 focus:border-emerald-500"
                    onkeydown="if(event.key==='Enter') handleChatInput()"
                    disabled>
                <button id="send-btn" onclick="handleChatInput()"
                    class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-4 rounded-xl disabled-control"
                    disabled>ì „ì†¡</button>
            </div>
        </div>
    </div>
</div>

<!-- ===================== FULL JAVASCRIPT ===================== -->
<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/*  API ì£¼ì†Œ ìë™ ì„¤ì • (localhost/ì‹¤ì„œë²„ ëª¨ë‘ ëŒ€ì‘)              */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const API_BASE_URL = (() => {
    const hostname = window.location.hostname;
    const protocol = window.location.protocol;
    const port = window.location.port || '8443';
    
    // ë¡œì»¬ ì ‘ì†
    if (!hostname || hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://127.0.0.1:8443';
    }
    
    // ì™¸ë¶€ ì ‘ì† (61.78.100.233)
    if (hostname === '61.78.100.233') {
        return `${protocol}//${hostname}:${port}`;
    }
    
    // ê¸°íƒ€ ë„ë©”ì¸
    return `${protocol}//${hostname}:${port}`;
})();

let USE_LLM = false;
let API_AVAILABLE = false;

let map = null;
let userMarker = null;
let shelterMarkers = [];
let openInfoWindows = [];
let currentUserPosition = null;  // í˜„ìœ„ì¹˜ ì €ì¥ìš©
let panorama = null;  // íŒŒë…¸ë¼ë§ˆ ê°ì²´

const chatWindow = document.getElementById('chat-window');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const geoBtn = document.getElementById('geo-btn');
const initialMessageEl = document.getElementById('initial-message');


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/*  API ìƒíƒœ í™•ì¸                                                */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function checkApiStatus() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/status`);
        if (response.ok) {
            const data = await response.json();
            API_AVAILABLE = true;
            USE_LLM = data.llm_available;
        }
    } catch (_) {
        API_AVAILABLE = false;
        USE_LLM = false;
    }
    updateLlmBadge();
}

/* ë°°ì§€ ì—…ë°ì´íŠ¸ */
function updateLlmBadge() {
    const badge = document.getElementById('llm-status');
    if (API_AVAILABLE && USE_LLM) {
        badge.className = "llm-badge llm-on";
        badge.textContent = "ğŸ¤– LLM ON";
    } else if (API_AVAILABLE) {
        badge.className = "llm-badge llm-off";
        badge.textContent = "ğŸ“ ê·œì¹™ ê¸°ë°˜";
    } else {
        badge.className = "llm-badge llm-off";
        badge.textContent = "ğŸ“‚ ë¡œì»¬ ëª¨ë“œ";
    }
}

function setControlsDisabled(disabled) {
    [sendBtn, geoBtn, chatInput].forEach(x => {
        x.disabled = disabled;
        if (disabled) x.classList.add("disabled-control");
        else x.classList.remove("disabled-control");
    });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* ë©”ì‹œì§€ UI                                                     */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function addMessage(sender, text, isResult = false) {
    const wrap = document.createElement('div');
    const box = document.createElement('div');

    if (sender === "user") {
        wrap.className = "flex justify-end";
        box.className = "bg-red-100 text-gray-900 p-3 rounded-2xl rounded-tr-none max-w-[80%] shadow-sm";
        box.innerHTML = text;
    } else {
        wrap.className = "flex justify-start";
        if (isResult) {
            /* ğŸ”½ğŸ”½ ì—¬ê¸° ìƒ‰ì„ ì´ˆë¡í†¤ìœ¼ë¡œ ë³€ê²½ */
            box.style.backgroundColor = "#22c55e";  // ì´ˆë¡ìƒ‰
            box.style.color = "#FFFFFF";            // í°ìƒ‰
            box.className = "p-3 rounded-2xl rounded-tl-none max-w-[90%] shadow-lg";
            box.innerHTML = `<p class="font-bold text-lg mb-1">ğŸ“ ëŒ€í”¼ì†Œ ê²€ìƒ‰ ê²°ê³¼</p>${text}`;
        } else {
            box.className = "bg-gray-100 text-gray-800 p-3 rounded-2xl rounded-tl-none max-w-[80%] shadow-sm";
            box.innerHTML = `<p class="font-semibold mb-1">ğŸ›¡ï¸ ëŒ€í”¼ì†Œ ë„ìš°ë¯¸</p>${text}`;
        }
    }

    wrap.appendChild(box);
    chatWindow.appendChild(wrap);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Haversine (ê±°ë¦¬ ê³„ì‚°)                                          */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const EARTH_RADIUS = 6371;
const toRad = deg => deg * Math.PI / 180;
function haversine(a, b, c, d) {
    const dLat = toRad(c - a), dLon = toRad(d - b);
    const lat1 = toRad(a), lat2 = toRad(c);
    const A = Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(lat1) * Math.cos(lat2);
    return EARTH_RADIUS * 2 * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A));
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/*  Server API: LLM ìœ„ì¹˜ ì¶”ì¶œ                                    */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function extractLocationWithLLM(query) {
    try {
        const res = await fetch(`${API_BASE_URL}/api/location/extract`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query, use_llm: USE_LLM })
        });
        return res.ok ? await res.json() : null;
    } catch { return null; }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/*  Server API: ì¢Œí‘œë¡œ ëŒ€í”¼ì†Œ ë¦¬ìŠ¤íŠ¸                              */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function searchSheltersByCoordinates(lat, lon) {
    try {
        const res = await fetch(`${API_BASE_URL}/api/shelters/nearest?lat=${lat}&lon=${lon}&k=5`);
        if (!res.ok) return null;
        const data = await res.json();
        return data.shelters || [];
    } catch { return null; }
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* í˜„ì¬ ìœ„ì¹˜ GPS                                                 */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleGeolocation() {
    addMessage("user", "ğŸ“ í˜„ìœ„ì¹˜ë¡œ ëŒ€í”¼ì†Œ ê²€ìƒ‰");
    addMessage("bot", "GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...");

    setControlsDisabled(true);

    if (!navigator.geolocation) {
        addMessage("bot", "âŒ ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì •ë³´ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        setControlsDisabled(false);
        return;
    }

    navigator.geolocation.getCurrentPosition(onSuccessGeolocation, onErrorGeolocation);
}

async function onSuccessGeolocation(pos) {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    addMessage("bot", `ìœ„ì¹˜í™•ì¸ ì™„ë£Œ! (lat ${lat.toFixed(4)}, lon ${lon.toFixed(4)})`);
    addMessage("bot", "ğŸ” ì£¼ë³€ ëŒ€í”¼ì†Œ íƒìƒ‰ ì¤‘...");

    const shelters = await searchSheltersByCoordinates(lat, lon);

    if (!shelters || shelters.length === 0) {
        addMessage("bot", "âŒ ì£¼ë³€ì— ëŒ€í”¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
        setControlsDisabled(false);
        return;
    }

    shelters.forEach(s => s.distance = haversine(lat, lon, s.lat, s.lon));
    shelters.sort((a,b)=>a.distance-b.distance);

    displayShelterResultsCurrent("í˜„ì¬ ìœ„ì¹˜", [lat, lon], shelters);
}

function onErrorGeolocation(e) {
    addMessage("bot", `âŒ ìœ„ì¹˜ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (ì½”ë“œ ${e.code})`);
    setControlsDisabled(false);
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* LLM ê²€ìƒ‰ + UI                                                 */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function handleChatInput() {
    const q = chatInput.value.trim();
    chatInput.value = "";
    if (!q) return;

    addMessage("user", q);
    setControlsDisabled(true);

    if (q.includes("í˜„ìœ„ì¹˜") || q.includes("ë‚´ ìœ„ì¹˜") || q.includes("í˜„ì¬ ìœ„ì¹˜")) {
        handleGeolocation();
        return;
    }

    if (!API_AVAILABLE) {
        addMessage("bot", "âŒ API ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        setControlsDisabled(false);
        return;
    }

    addMessage("bot", "ğŸ¤– ì…ë ¥ ë‚´ìš©ì„ ë¶„ì„ ì¤‘...");
    const result = await extractLocationWithLLM(q);
    console.log("result ---", result);
    if (!result || !result.success) {
        addMessage("bot", result?.message || "âŒ ì§€ëª…ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        setControlsDisabled(false);
        return;
    }

    // 1. ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì¶œë ¥
    if (result.message) {
        console.log("result.message", result.message);
        addMessage("bot", result.message.replace(/\n/g,"<br>"));
    }

    // 2. ëŒ€í”¼ì†Œ ì •ë³´ê°€ ìˆìœ¼ë©´ ì§€ë„ í‘œì‹œ
    if (result.shelters && result.shelters.length > 0 && result.coordinates) {
        displayShelterResults(result.location, result.coordinates, result.shelters);
    }  else {
        // 3. ì§€ë„ ì •ë³´ê°€ ì—†ìœ¼ë©´ í˜„ìœ„ì¹˜ë¡œ ë¦¬ì…‹
        resetMapToCurrentLocation();
    }

    setControlsDisabled(false);
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* ëŒ€í”¼ì†Œ ê²°ê³¼ í‘œì‹œ + ì§€ë„ ë§ˆì»¤   (í˜„ì¬ ìœ„ì¹˜)                               */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function displayShelterResultsCurrent(locationName, coords, shelters) {
    const nearest = shelters[0];

    let lists = "";
    shelters.forEach((s, i) => {
        lists += `
          <div class="mt-1 text-sm ${i===0 ? 'font-bold text-emerald-100' : 'opacity-80'}">
            ${i===0 ? 'ğŸ† ' : `${i+1}. `}${s.name} (${s.distance.toFixed(2)}km)
          </div>
        `;
    });

    addMessage("bot",
      `
        <p class="text-xl font-bold">${nearest.name}</p>
        <p>${nearest.address}</p>
        <p class="mt-2">ğŸ“ ê±°ë¦¬: <b>${nearest.distance.toFixed(2)}km</b></p>
        <p class="mt-2">ìˆ˜ìš©ì¸ì›: <b>${nearest.capacity.toLocaleString()}ëª…</b></p>
        <details class="mt-3"><summary>ğŸ“‹ ì „ì²´ ëŒ€í”¼ì†Œ ëª©ë¡ ë³´ê¸°</summary>
            <div class="mt-2 ml-2 max-h-40 overflow-y-auto">${lists}</div>
        </details>
      `,
      true
    );

    showMapWithMultipleShelters(coords[0], coords[1], shelters, locationName);
    setControlsDisabled(false);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* ì§€ë„ë¥¼ í˜„ìœ„ì¹˜ë¡œ ë¦¬ì…‹                                           */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resetMapToCurrentLocation() {
    if (!map || !currentUserPosition) return;
    
    // ê¸°ì¡´ ëŒ€í”¼ì†Œ ë§ˆì»¤ ì œê±°
    shelterMarkers.forEach(m => m.setMap(null));
    shelterMarkers = [];
    closeAllInfoWindows();
    
    // í˜„ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
    map.setCenter(currentUserPosition.position);
    map.setZoom(14);
    
    // í˜„ìœ„ì¹˜ ë§ˆì»¤ê°€ ì—†ìœ¼ë©´ ë‹¤ì‹œ ìƒì„±
    if (!userMarker || !userMarker.getMap()) {
        userMarker = new naver.maps.Marker({
            map: map,
            position: currentUserPosition.position,
            icon: {
                content: `<div style="background:#4299E1;color:white;padding:6px 10px;border-radius:12px;font-weight:bold;box-shadow:0 2px 6px rgba(0,0,0,0.3);">ğŸ“ í˜„ì¬ ìœ„ì¹˜</div>`,
                anchor: new naver.maps.Point(50, 60)
            }
        });
        
        const userInfoWindow = new naver.maps.InfoWindow({
            content: `
                <div style="padding:15px;min-width:200px;">
                    <div style="font-weight:bold;color:#1f2937;margin-bottom:8px;">ğŸ“ í˜„ì¬ ìœ„ì¹˜</div>
                    <div style="color:#6b7280;font-size:13px;">
                        ìœ„ë„: ${currentUserPosition.lat.toFixed(6)}<br>
                        ê²½ë„: ${currentUserPosition.lon.toFixed(6)}
                    </div>
                </div>
            `
        });
        
        naver.maps.Event.addListener(userMarker, "click", () => {
            closeAllInfoWindows();
            userInfoWindow.open(map, userMarker);
            openInfoWindows.push(userInfoWindow);
            
            // í˜„ìœ„ì¹˜ íŒŒë…¸ë¼ë§ˆ í‘œì‹œ
            if (panorama) {
                panorama.setPosition(currentUserPosition.position);
                panorama.setVisible(true);
                const placeholder = document.getElementById('pano-placeholder');
                if (placeholder) placeholder.style.display = 'none';
            }
        });
    }
    
    // í˜„ìœ„ì¹˜ íŒŒë…¸ë¼ë§ˆë¡œ ì—…ë°ì´íŠ¸
    if (panorama) {
        panorama.setPosition(currentUserPosition.position);
        panorama.setVisible(true);
        const placeholder = document.getElementById('pano-placeholder');
        if (placeholder) placeholder.style.display = 'none';
    }
    
    console.log('ì§€ë„ë¥¼ í˜„ìœ„ì¹˜ë¡œ ë¦¬ì…‹:', currentUserPosition.lat, currentUserPosition.lon);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* ëŒ€í”¼ì†Œ ê²°ê³¼ í‘œì‹œ + ì§€ë„ ë§ˆì»¤   (ì§€ë„ ë§ˆì»¤)                               */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function displayShelterResults(locationName, coords, shelters) {
    const nearest = shelters[0];

    showMapWithMultipleShelters(coords[0], coords[1], shelters, locationName);
    setControlsDisabled(false);
}

function closeAllInfoWindows() {
    openInfoWindows.forEach(w => w.close());
    openInfoWindows = [];
}

function showMapWithMultipleShelters(centerLat, centerLon, shelters, locationName) {
    if (typeof naver === 'undefined') return;

    const center = new naver.maps.LatLng(centerLat, centerLon);

    if (!map) {
        map = new naver.maps.Map("map", { center, zoom: 14 });
        naver.maps.Event.addListener(map, "click", closeAllInfoWindows);
    } else {
        map.setCenter(center);
        map.setZoom(14);
    }

    closeAllInfoWindows();
    if (userMarker) userMarker.setMap(null);
    shelterMarkers.forEach(m => m.setMap(null));
    shelterMarkers = [];

    userMarker = new naver.maps.Marker({
        map,
        position: center,
        icon: {
            content: `<div style="background:#4299E1;color:white;padding:6px 10px;border-radius:12px;font-weight:bold;">ğŸ“ ${locationName}</div>`,
            anchor: new naver.maps.Point(50, 60)
        }
    });

    const bounds = new naver.maps.LatLngBounds(center, center);

    shelters.forEach((s, i) => {
        const p = new naver.maps.LatLng(s.lat, s.lon);
        bounds.extend(p);

        const marker = new naver.maps.Marker({
            map,
            position: p,
            icon: i===0 ? {
                url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
            } : undefined
        });

        const iw = new naver.maps.InfoWindow({
            content:
            `<div style="padding:10px;">
                ${i===0 ? "<b>ğŸ† ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í”¼ì†Œ</b><br>" : ""}
                <b>${s.name}</b><br>${s.address}<br>
                ê±°ë¦¬: ${s.distance.toFixed(2)}km<br>
                ìˆ˜ìš©ì¸ì›: ${s.capacity.toLocaleString()}ëª…
            </div>`
        });

        naver.maps.Event.addListener(marker, "click", () => {
            closeAllInfoWindows();
            iw.open(map, marker);
            openInfoWindows.push(iw);
            
            // ë§ˆì»¤ ìœ„ì¹˜ì˜ íŒŒë…¸ë¼ë§ˆ í‘œì‹œ
            if (panorama) {
                panorama.setPosition(p);
                panorama.setVisible(true);
                const placeholder = document.getElementById('pano-placeholder');
                if (placeholder) placeholder.style.display = 'none';
            }
        });

        shelterMarkers.push(marker);
    });

    map.fitBounds(bounds, { padding: 60 });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* ì´ˆê¸° ì§€ë„ ì„¤ì • ë° í˜„ìœ„ì¹˜ í‘œì‹œ                                   */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initializeMap() {
    if (typeof naver === 'undefined') {
        console.error('Naver Maps APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }

    // ê¸°ë³¸ ì„œìš¸ ì¤‘ì‹¬ ì¢Œí‘œ (ì„œìš¸ì‹œì²­)
    const defaultCenter = new naver.maps.LatLng(37.5665, 126.9780);
    
    // ì§€ë„ ì´ˆê¸°í™”
    map = new naver.maps.Map("map", {
        center: defaultCenter,
        zoom: 12,
        minZoom: 8,
        maxZoom: 18
    });

    // íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™”
    try {
        panorama = new naver.maps.Panorama("pano", {
            position: defaultCenter,
            pov: {
                pan: 0,
                tilt: 0,
                fov: 100
            },
            visible: false  // ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€
        });
        console.log('íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™” ì™„ë£Œ');
    } catch (e) {
        console.warn('íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
    }

    // ì§€ë„ í´ë¦­ ì‹œ ì •ë³´ì°½ ë‹«ê¸° + íŒŒë…¸ë¼ë§ˆ ì—…ë°ì´íŠ¸
    naver.maps.Event.addListener(map, "click", function(e) {
        closeAllInfoWindows();
        
        // í´ë¦­ ìœ„ì¹˜ì˜ íŒŒë…¸ë¼ë§ˆ í‘œì‹œ
        if (panorama) {
            const clickedPos = e.coord;
            panorama.setPosition(clickedPos);
            panorama.setVisible(true);
            
            // placeholder ìˆ¨ê¸°ê¸°
            const placeholder = document.getElementById('pano-placeholder');
            if (placeholder) placeholder.style.display = 'none';
            
            console.log('íŒŒë…¸ë¼ë§ˆ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:', clickedPos.toString());
        }
    });

    // í˜„ìœ„ì¹˜ ìë™ í‘œì‹œ ì‹œë„
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            // ì„±ê³µ ì‹œ
            (position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                const userPosition = new naver.maps.LatLng(userLat, userLon);

                // í˜„ìœ„ì¹˜ ì €ì¥ (ì§€ë„ ì •ë³´ ì—†ì„ ë•Œ ì‚¬ìš©)
                currentUserPosition = { lat: userLat, lon: userLon, position: userPosition };


                // ì§€ë„ ì¤‘ì‹¬ì„ í˜„ìœ„ì¹˜ë¡œ ì´ë™
                map.setCenter(userPosition);
                map.setZoom(14);

                // í˜„ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
                userMarker = new naver.maps.Marker({
                    map: map,
                    position: userPosition,
                    icon: {
                        content: `<div style="background:#4299E1;color:white;padding:6px 10px;border-radius:12px;font-weight:bold;box-shadow:0 2px 6px rgba(0,0,0,0.3);">ğŸ“ í˜„ì¬ ìœ„ì¹˜</div>`,
                        anchor: new naver.maps.Point(50, 60)
                    }
                });

                // í˜„ìœ„ì¹˜ ì •ë³´ì°½
                const userInfoWindow = new naver.maps.InfoWindow({
                    content: `
                        <div style="padding:15px;min-width:200px;">
                            <div style="font-weight:bold;color:#1f2937;margin-bottom:8px;">ğŸ“ í˜„ì¬ ìœ„ì¹˜</div>
                            <div style="color:#6b7280;font-size:13px;">
                                ìœ„ë„: ${userLat.toFixed(6)}<br>
                                ê²½ë„: ${userLon.toFixed(6)}
                            </div>
                        </div>
                    `
                });

                // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ ì—´ê¸° + íŒŒë…¸ë¼ë§ˆ
                naver.maps.Event.addListener(userMarker, "click", () => {
                    closeAllInfoWindows();
                    userInfoWindow.open(map, userMarker);
                    openInfoWindows.push(userInfoWindow);
                    
                    // í˜„ìœ„ì¹˜ íŒŒë…¸ë¼ë§ˆ í‘œì‹œ
                    if (panorama) {
                        panorama.setPosition(userPosition);
                        panorama.setVisible(true);
                        const placeholder = document.getElementById('pano-placeholder');
                        if (placeholder) placeholder.style.display = 'none';
                    }
                });

                console.log('í˜„ìœ„ì¹˜ í‘œì‹œ ì™„ë£Œ:', userLat, userLon);
            },
            // ì‹¤íŒ¨ ì‹œ (ê¶Œí•œ ê±°ë¶€, ì‹œê°„ ì´ˆê³¼ ë“±)
            (error) => {
                console.warn('í˜„ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error.message);
                // ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ ì§€ë„ëŠ” í‘œì‹œë¨
            },
            // ì˜µì…˜
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5ë¶„ê°„ ìºì‹œ ì‚¬ìš©
            }
        );
    } else {
        console.warn('ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* í˜„ìœ„ì¹˜ ê¸°ë°˜ ëŒ€í”¼ì†Œ ê²€ìƒ‰ í•¨ìˆ˜ (ì •ë³´ì°½ ë²„íŠ¼ìš©)                     */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function searchNearestShelters(lat, lon) {
    addMessage("user", "ğŸ“ í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì£¼ë³€ ëŒ€í”¼ì†Œ ê²€ìƒ‰");
    addMessage("bot", "ğŸ” ì£¼ë³€ ëŒ€í”¼ì†Œë¥¼ íƒìƒ‰ ì¤‘ì…ë‹ˆë‹¤...");
    
    setControlsDisabled(true);
    
    const shelters = await searchSheltersByCoordinates(lat, lon);
    
    if (!shelters || shelters.length === 0) {
        addMessage("bot", "âŒ ì£¼ë³€ì— ëŒ€í”¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
        setControlsDisabled(false);
        return;
    }
    
    // ê±°ë¦¬ ê³„ì‚° ë° ì •ë ¬
    shelters.forEach(s => s.distance = haversine(lat, lon, s.lat, s.lon));
    shelters.sort((a, b) => a.distance - b.distance);
    
    displayShelterResultsCurrent("í˜„ì¬ ìœ„ì¹˜", [lat, lon], shelters);
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* ì´ˆê¸° ì‹¤í–‰                                                     */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener("DOMContentLoaded", async () => {
    await checkApiStatus();

    // ì§€ë„ ì´ˆê¸°í™” (í˜„ìœ„ì¹˜ í¬í•¨)
    initializeMap();

    if (API_AVAILABLE) {
        initialMessageEl.innerHTML =
            `<span class="text-black-600 font-normal">ì €ëŠ” </span>
        <span class="text-red-600 font-bold text-lg">ì¬ë‚œì•ˆì „ ì±—ë´‡</span>
        <span class="text-black-600 font-normal">ì…ë‹ˆë‹¤ ğŸ¤–</span><br>
             <span class="text-blue-700 font-bold">ì£¼ì†Œ / ì¥ì†Œëª…</span>
        <span class="text-black-700 font-normal">ì„ ì…ë ¥í•˜ê±°ë‚˜</span>
        <span class="text-blue-700 font-bold">"í˜„ìœ„ì¹˜"</span>
        <span class="text-black-700 font-normal">ë¡œ ê²€ìƒ‰í•´ ë³´ì„¸ìš”.</span>`;
        setControlsDisabled(false);
    } else {
        initialMessageEl.innerHTML =
            `<span class="text-red-600 font-bold">âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨. FastAPI ì„œë²„ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</span>`;
    }
});
</script>

</body>
</html>
